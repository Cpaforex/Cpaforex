<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CONTINUOUS PROFIT ACADEMY</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <!-- بارگذاری ethers.js نسخه 6 از CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <!-- بارگذاری WalletConnect Provider از CDN رسمی -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <!-- بارگذاری WalletConnect Handler -->
    <script src="js/walletconnect-handler.js?v=5.7"></script>

  <!-- بارگذاری WalletConnect UMD به صورت لوکال -->
  <script src="js/walletconnect-v1.8.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <script>
    // این متغیر را هر زمان جلسه آنلاین فعال بود true کنید
    var isSessionActive = false; // مقدار پیش‌فرض: جلسه فعال نیست
  </script>
  <div id="online-session-bubble" style="display:none;">
    <span class="bubble-text">جلسه آنلاین در حال برگزاری است! 🚀</span>
    <span class="bubble-timer" id="bubble-timer"></span>
    <a href="learning.html" class="bubble-link" target="_blank">ورود به کلاس</a>
    <span class="bubble-close" id="bubble-close">×</span>
  </div>
  <div id="bubble-mini" style="display:none;">
    <span class="bubble-mini-icon">🚀</span>
  </div>
  <script>
    function formatCountdown(ms) {
      if (ms <= 0) return '00:00:00';
      let s = Math.floor(ms / 1000);
      let h = Math.floor(s / 3600);
      s = s % 3600;
      let m = Math.floor(s / 60);
      s = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function showSessionBubble() {
      const info = window.sessionInfo;
      if (!info || !info.active) return;
      const bubble = document.getElementById('online-session-bubble');
      const mini = document.getElementById('bubble-mini');
      const timer = document.getElementById('bubble-timer');
      const link = bubble.querySelector('.bubble-link');
      link.href = info.link || 'learning.html';
      bubble.style.display = 'flex';
      mini.style.display = 'none';
      // شمارش معکوس
      function updateTimer() {
        const now = Date.now();
        if (now < info.startTime) {
          timer.textContent = 'شروع تا جلسه: ' + formatCountdown(info.startTime - now);
        } else if (now < info.endTime) {
          timer.textContent = 'زمان باقی‌مانده: ' + formatCountdown(info.endTime - now);
        } else {
          timer.textContent = 'جلسه به پایان رسید';
        }
      }
      updateTimer();
      window._bubbleTimerInterval = setInterval(updateTimer, 1000);
    }
    function hideSessionBubble() {
      document.getElementById('online-session-bubble').style.display = 'none';
      document.getElementById('bubble-mini').style.display = 'flex';
      if (window._bubbleTimerInterval) clearInterval(window._bubbleTimerInterval);
    }
    function showMiniBubble() {
      document.getElementById('bubble-mini').style.display = 'flex';
      document.getElementById('online-session-bubble').style.display = 'none';
    }
    function expandMiniBubble() {
      showSessionBubble();
    }
    // رویداد بستن
    document.addEventListener('DOMContentLoaded', function() {
      if (window.sessionInfo && window.sessionInfo.active) {
        showSessionBubble();
      }
      document.getElementById('bubble-close').onclick = hideSessionBubble;
      document.getElementById('bubble-mini').onclick = expandMiniBubble;
    });
  </script>

  <div id="main-dashboard" class="page-section expandable-container">
    <div class="expand-header">
      <header>
        <h1 class="shimmer-title" style="font-family: 'Montserrat', sans-serif; font-size:2.5rem; letter-spacing:0.12em; color:#222; text-transform:uppercase; font-weight:700; text-shadow:0 2px 12px #00ff8840, 0 1px 0 #fff;">CONTINUOUS PROFIT ACADEMY</h1>
      
      </header>
    </div>
    <div class="expand-content">
      <div class="dashboard-cards" style="display:flex;justify-content:center;flex-wrap:wrap;gap:1rem;max-width:1200px;margin:0 auto;">
        <div class="dashboard-card">
          <div class="dashboard-card-icon">👛</div>
          <div class="dashboard-card-content">
            <div id="dashboard-wallets-count">-WALLET</div>
            <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">ALL WALLETS</h4>
          </div>
        </div>

        <!-- حذف کارت قیمت LVL (USD) -->
        <!-- حذف کارت قیمت LVL (POL) -->
        <div class="dashboard-card">
          <div class="dashboard-card-icon"></div>
          <div class="dashboard-card-content">
            <div id="circulating-supply">-CPA</div>
            <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">TOTAL SUPPLY</h4>
      </div>
    </div>
    <!-- کارت total-users (کاربران) حذف شد -->
            <div class="dashboard-card">
          <div class="dashboard-card-icon"></div>
          <div class="dashboard-card-content">
            <div id="total-points">-POINT</div>
            <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">TOTAL POINTS</h4>
      </div>
    </div>
    <div class="dashboard-card">
          <div class="dashboard-card-icon"></div>
          <div class="dashboard-card-content">
            <div id="point-value">-CPA</div>
            <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">POINT VALUE</h4>
      </div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-card-icon"></div>
      <div class="dashboard-card-content">
            <div id="contract-token-balance">-CPA</div>
    <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">CPA BALANCE</h4>
      </div>
    </div>
    <div class="dashboard-card">
      <div class="dashboard-card-icon"></div>
      <div class="dashboard-card-content">
        <div id="reward-pool">-POL</div>
        <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">POL BALANCE</h4>
      </div>
    </div>
    <div class="dashboard-card" id="dashboard-cashback-card">
      <div class="dashboard-card-icon"></div>
      <div class="dashboard-card-content">
        <div id="dashboard-cashback-value">-</div>
        <h4 style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;text-transform:uppercase;font-size:1.1rem;">HELP FUND</h4>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Price Chart Section -->
  <div id="price-chart-section" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;">
    <div class="expand-header" style="padding:0 1.5rem;">
      <h2 style="margin:0 0 0.5rem 0;">📈 چارت قیمت‌ها</h2>
              <p style="margin:0 0 0.5rem 0;">نمایش لحظه‌ای قیمت‌های توکن CPA، POL و نرخ تبدیل</p>
    </div>
    <div class="expand-content" style="padding:0;">
      <div class="price-chart-container" style="padding:0;width:100%;">
        <!-- Time Period Filters -->
        <div class="price-chart-time-filters-container" style="margin:0 0 0.5rem 0;">
          <div class="price-chart-time-filters" id="price-chart-time-filters" style="gap:0.2rem;">
            <!-- Time period buttons will be added here by JavaScript -->
          </div>
        </div>
        
        <!-- Line Chart Canvas -->
        <div class="price-chart-canvas-container" style="margin:0;min-width:0;width:100%;">
          <canvas id="price-chart-canvas" style="width:100%!important;"></canvas>
        </div>
        
        <!-- Price Cards Grid -->
        <div class="three-buttons-row" style="margin:0 auto;gap:1.2rem;display:flex;flex-direction:row;justify-content:center;align-items:center;width:90%;max-width:480px;">
          <button class="three-btn" style="min-width:120px;" disabled>
            <span style="font-weight:bold;color:#ff6b6b;" id="chart-pol-usd">-</span><br>
            <span style="color:#00ccff;font-size:0.95rem;">POL (USD)</span>
          </button>
          <button class="three-btn" style="min-width:120px;" disabled>
            <span style="font-weight:bold;color:#00ccff;" id="chart-lvl-pol">-</span><br>
            <span style="color:#00ccff;font-size:0.95rem;">CPA / POL</span>
          </button>
          <button class="three-btn" style="min-width:120px;" disabled>
            <span style="font-weight:bold;color:#00ff88;" id="chart-lvl-usd">-</span><br>
            <span style="color:#00ccff;font-size:0.95rem;">CPA (USD)</span>
          </button>
        </div>
        
        <!-- Chart Controls -->
        <div class="price-chart-controls" style="display:flex;justify-content:center;">
          <div class="price-chart-info">
            <span>آخرین بروزرسانی: <span id="price-chart-last-update">-</span></span>
          </div>
        </div>
        
        <!-- Messages -->
        <div class="price-chart-messages">
          <div class="price-chart-error" id="price-chart-error"></div>
          <div class="price-chart-success" id="price-chart-success"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- تایمر تبلیغاتی جلسه آنلاین بعدی -->
  <div id="session-timer-box" style="display:none;max-width:600px;margin:2rem auto 1rem auto;text-align:center;">
    <h2 style="margin-bottom:0.5rem;">⏰ شمارش معکوس جلسه آنلاین بعدی</h2>
    <div id="session-timer" style="font-size:2rem;font-weight:bold;background:linear-gradient(90deg,#00ff88,#00ccff);color:#181c2a;padding:1rem 2rem;border-radius:12px;display:inline-block;"></div>
    <div style="margin-top:1rem;">
        <a href="learning.html" id="join-session-btn" style="display:inline-block;padding:0.7rem 2rem;background:#a786ff;color:#181c2a;border-radius:8px;font-weight:bold;text-decoration:none;font-size:1.1rem;">ورود به کلاس آنلاین</a>
    </div>
  </div>

  <div class="tab-container" style="max-width:700px;margin:0.5rem auto 0.5rem auto;">
    <div class="tab-headers" style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <div class="dashboard-cards-list">
        <button class="tab-btn list-btn active" id="tab-swap-btn" type="button" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">SWAP</button>
        <button class="tab-btn list-btn" id="tab-network-btn" type="button" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">NETWORK</button>
        <button class="tab-btn list-btn" id="tab-profile-btn" type="button" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">PROFILE</button>
        <button class="tab-btn list-btn" id="tab-reports-btn" type="button" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">REPORTS</button>
        <a class="tab-btn list-btn" id="tab-news-btn" href="news.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">NEWS</a>
        <a class="tab-btn list-btn" id="tab-shop-btn" href="shop.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">SHOP</a>
        <a class="tab-btn list-btn" id="tab-learning-btn" href="learning.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">LEARNING</a>
        <a class="tab-btn list-btn" id="tab-lottery-btn" href="lottery.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">LOTTERY</a>
        <button class="tab-btn list-btn" id="tab-about-btn" type="button" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">ABOUT</button>
        <a class="tab-btn list-btn" id="tab-prop-btn" href="prop.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">پاس پراپ</a>
        <a class="tab-btn list-btn" id="tab-autotrade-btn" href="autotrade-license.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">ربات‌های اتوترید</a>
        <a class="tab-btn list-btn" id="tab-signal-btn" href="signal.html" style="font-family:'Montserrat',sans-serif;letter-spacing:0.04em;">سیگنال‌ها</a>
      </div>
    </div>
  </div>
  <div id="main-swap" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;">
    <div class="expand-header">
      <h2 class="swap-title">  </h2>
    </div>
    <div class="expand-content">
            <div class="swap-container" style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
        <!-- باکس تبدیل -->
        <div style="flex: 1; min-width: 300px; max-width: 400px;">
          <form id="swapForm" class="swap-form">
            <h3 style="color:#00ff88;margin-bottom:1rem;text-align:center;">تبدیل</h3>
            <label for="swapDirection">نوع تبدیل:</label>
            <select id="swapDirection">
              <option value="matic-to-lvl">POL → CPA</option>
              <option value="lvl-to-matic">CPA → POL</option>
            </select>
            <label for="swapAmount">مقدار:</label>
            <div class="amount-row">
              <input type="number" id="swapAmount" placeholder="مقدار را وارد کنید" step="any" />
              <button type="button" id="maxButton" class="max-btn">حداکثر</button>
            </div>
            <div class="swap-info" id="swapInfo">نرخ تبدیل: -</div>
            <button type="submit" id="swapButton">تبدیل</button>
            <div class="balances">
              <span id="maticBalance">MATIC: -</span> | <span id="lvlBalance">CPA: -</span>
            </div>
            <div class="swap-status" id="swapStatus"></div>
          </form>
        </div>
        
        <!-- باکس انتقال توکن/متیک -->
        <div style="flex: 1; min-width: 300px; max-width: 400px;">
          <div id="transfer-box" style="background:rgba(0,255,136,0.05);border-radius:12px;padding:1.5rem 1rem;box-shadow:0 2px 12px #00ff8840;">
            <h3 style="color:#00ff88;margin-bottom:1rem;text-align:center;">انتقال</h3>
            <form id="transferForm">
              <!-- انتخاب نوع انتقال -->
              <div style="display:flex;gap:1rem;justify-content:center;margin-bottom:1rem;">
                <label><input type="radio" name="transferType" value="matic" checked> POL</label>
                <label><input type="radio" name="transferType" value="lvl"> CPA</label>
              </div>
              <!-- مقدار -->
              <div class="amount-row">
                <input type="number" id="transferAmount" placeholder="مقدار را وارد کنید" step="any" style="width:100%;margin-bottom:0.5rem;" />
              </div>
              <!-- جستجوی ایندکس (یکپارچه با انتقال) -->
              <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
                <input type="number" id="searchIndexInput" placeholder="ایندکس کاربر" style="width:50%;direction:ltr;" />
                <button type="button" id="searchIndexBtn" style="width:50%;background:#a786ff;color:#fff;border-radius:8px;">جستجوی ایندکس</button>
              </div>
              <!-- فیلد آدرس مقصد -->
              <div class="amount-row">
                <input type="text" id="transferTo" placeholder="آدرس مقصد (0x...)" style="direction:ltr;width:100%;" />
              </div>
              <button type="submit" id="transferButton" style="width:100%;margin-top:1rem;background:#00ff88;color:#181c2a;font-weight:bold;border-radius:8px;padding:0.7rem 0;">انتقال</button>
              <div class="swap-status" id="transferStatus" style="margin-top:0.7rem;"></div>
            </form>
          </div>
        </div>
      </div>

        <!-- باکس جستجوی ایندکس به آدرس -->
        <!-- هیچ div با id="index-to-address-box" نباید باقی بماند -->
      </div>
    </div>
  </div>
  <div id="main-network" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;display:none;">
    <div class="expand-header">
      <h2 class="network-title"></h2>
    </div>
    <div class="expand-content">
      <div class="network-container">

        
        <!-- کارت اطلاعات کاربر شبکه -->
        <div id="network-user-card" style="background:#101c2c;border-radius:16px;padding:1.5rem 1rem;margin-bottom:2rem;box-shadow:0 2px 12px #0002;max-width:420px;margin-left:auto;margin-right:auto;">
          <div style="display:flex;justify-content:space-between;"><span style="color:#00ff88;">آدرس:</span><span id="user-address" style="direction:ltr;color:#fff;font-weight:bold;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;"><span style="color:#00ff88;">معرف:</span><span id="user-referrer" style="color:#fff;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;"><span style="color:#00ccff;">موجودی POL:</span><span id="user-pol-balance" style="color:#fff;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;"><span style="color:#00ccff;">موجودی CPA:</span><span id="user-lvl-balance" style="color:#fff;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;"><span style="color:#00ff88;">سقف درآمد باینری:</span><span id="user-binary-cap" style="color:#fff;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;"><span style="color:#00ff88;">دریافت‌شده:</span><span id="user-claimed" style="color:#fff;">-</span></div>
          <div style="display:flex;justify-content:space-between;margin-top:0.7rem;align-items:center;"><span style="color:#00ff88;">لینک دعوت:</span><span id="user-ref-link" style="direction:ltr;color:#fff;background:#181c2a;padding:0.3rem 0.7rem;border-radius:8px;">-</span><button id="copy-ref-link" style="margin-right:0.5rem;background:linear-gradient(90deg,#00ff88,#00ccff);color:#000;border:none;border-radius:8px;padding:0.3rem 1.2rem;cursor:pointer;">کپی</button></div>
        </div>
        
        <!-- بخش ثبت‌نام و ارتقا -->
        <div id="main-register" style="max-width: 600px; margin: 0 auto; padding: 1rem;">
          <!-- فرم ثبت‌نام برای کاربران جدید -->
          <div id="registration-form" style="display: none; background: #101c2c; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 12px #0002;">
            <h3 style="color: #00ff88; margin-bottom: 1rem; text-align: center;">📝 ثبت‌نام جدید</h3>
            <div style="margin-bottom: 1rem;">
              <label for="referrer-address" style="color: #fff; display: block; margin-bottom: 0.5rem;">آدرس معرف (اختیاری):</label>
              <input type="text" id="referrer-address" placeholder="0x..." style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #333; background: #181c2a; color: #fff; font-family: monospace;">
            </div>
            <div id="registration-info"></div>
            <button id="register-btn" class="register-btn" style="width: 100%; margin-top: 1rem;">ثبت‌نام</button>
            <div id="register-status" class="profile-status" style="margin-top: 0.5rem;"></div>
          </div>
          
          <!-- فرم ارتقا برای کاربران فعال -->
          <div id="upgrade-form" style="display: none; background: #101c2c; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 12px #0002;">
            <h3 style="color: #00ccff; margin-bottom: 1rem; text-align: center;">🚀 ارتقا حساب</h3>
            <div style="margin-bottom: 1rem;">
              <label for="upgrade-amount" style="color: #fff; display: block; margin-bottom: 0.5rem;">مقدار CPA برای ارتقا:</label>
              <input type="number" id="upgrade-amount" placeholder="0.0" step="0.1" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #333; background: #181c2a; color: #fff;">
            </div>
            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #ccc;">ارزش دلاری:</span>
                <span id="upgrade-usd-value" style="color: #00ccff; font-weight: bold;">$0.00 USD</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #ccc;">امتیاز کسب شده:</span>
                <span id="upgrade-points-gain" style="color: #00ff88; font-weight: bold;">0 امتیاز</span>
              </div>
            </div>
            <button id="upgrade-btn" class="register-btn" style="width: 100%; margin-top: 1rem; background: #00ccff; color: #000;">ارتقا</button>
            <div id="upgrade-status" class="profile-status" style="margin-top: 0.5rem;"></div>
          </div>
          
          <!-- اطلاعات موجودی -->
          <div id="user-balance-box" style="background: #101c2c; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 12px #0002; display:none;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #ccc; font-size: 0.9rem;">موجودی CPA:</span>
              <span id="user-lvl-balance" style="color: #00ff88; font-weight: bold; font-size: 0.9rem;">-</span>
            </div>
          </div>
        </div>
        

        
        <!-- نمایش درخت شبکه -->
        <div id="network-tree"></div>
      </div>
      <!-- دکمه ثبت جدید برای حساب فعال در شبکه -->
      <button id="new-register-btn" class="register-btn" style="width: 100%; display: none; margin: 2rem 0;">ثبت جدید</button>
    </div>
  </div>

  <div id="main-profile" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;display:none;">
    <div class="expand-header">
      <h2 class="profile-title"> </h2>
    </div>
    <div class="expand-content">
      <div class="profile-container">
        <!-- کارت اطلاعات شخصی -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">👤</div>
            <h3>اطلاعات شخصی</h3>
          </div>
          <div class="section-content">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">آدرس کیف پول</div>
                <div class="info-value" id="profile-address">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">معرف</div>
                <div class="info-value" id="profile-referrer">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">لینک دعوت</div>
                <div class="info-value-with-action">
                  <span id="profile-referral-link">-</span>
                  <button id="copyProfileReferral" class="action-btn">📋 کپی</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- کارت موجودی‌ها -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">💰</div>
            <h3>موجودی‌ها</h3>
          </div>
          <div class="section-content">
            <div class="balance-grid">
              <div class="balance-card">
                <div class="balance-icon">🟣</div>
                <div class="balance-info">
                  <div class="balance-label">موجودی POL</div>
                  <div class="balance-value" id="profile-matic">-</div>
                  <div class="balance-usd" id="profile-matic-usd">-</div>
                </div>
              </div>
              <div class="balance-card">
                <div class="balance-icon">🟢</div>
                <div class="balance-info">
                  <div class="balance-label">موجودی CPA</div>
                  <div class="balance-value" id="profile-lvl">-</div>
                  <div class="balance-usd" id="profile-lvl-usd">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- کارت شبکه باینری -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">🌳</div>
            <h3>شبکه باینری</h3>
          </div>
          <div class="section-content">
            <div class="binary-grid">
              <div class="binary-stat">
                <div class="stat-icon">⬅️</div>
                <div class="stat-info">
                  <div class="stat-label">امتیاز چپ</div>
                  <div class="stat-value" id="profile-leftPoints">-</div>
                </div>
              </div>
              <div class="binary-stat">
                <div class="stat-icon">➡️</div>
                <div class="stat-info">
                  <div class="stat-label">امتیاز راست</div>
                  <div class="stat-value" id="profile-rightPoints">-</div>
                </div>
              </div>
              <div class="binary-stat">
                <div class="stat-icon">📊</div>
                <div class="stat-info">
                  <div class="stat-label">سقف درآمد</div>
                  <div class="stat-value" id="profile-income-cap">-</div>
                </div>
              </div>
              <div class="binary-stat">
                <div class="stat-icon">💸</div>
                <div class="stat-info">
                  <div class="stat-label">دریافت‌شده</div>
                  <div class="stat-value" id="profile-received">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- کارت معاملات -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">📈</div>
            <h3>معاملات و سرمایه‌گذاری</h3>
          </div>
          <div class="section-content">
            <div class="transaction-grid">
              <div class="transaction-item">
                <div class="transaction-label">کل واریزی</div>
                <div class="transaction-value" id="profile-depositedAmount">-</div>
              </div>
              <div class="transaction-item">
                <div class="transaction-label">باقیمانده خریدها</div>
                <div class="transaction-value" id="profile-purchased-kind">-</div>
              </div>
              <div class="transaction-item">
                <div class="transaction-label">درآمد رفرال</div>
                <div class="transaction-value" id="profile-refclimed">-</div>
              </div>
              <div class="transaction-item">
                <div class="transaction-label">کل سود ماهانه</div>
                <div class="transaction-value" id="profile-totalMonthlyRewarded">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- کارت تاریخچه -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">📅</div>
            <h3>تاریخچه برداشت‌ها</h3>
          </div>
          <div class="section-content">
            <div class="history-grid">
              <div class="history-item">
                <div class="history-label">آخرین برداشت پاداش</div>
                <div class="history-value" id="profile-lastClaimTime">-</div>
              </div>
              <div class="history-item">
                <div class="history-label">آخرین برداشت ماهانه</div>
                <div class="history-value" id="profile-lastMonthlyClaim">-</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- کارت دکمه‌های برداشت -->
        <div class="profile-section">
          <div class="section-header">
            <div class="section-icon">💸</div>
            <h3>برداشت پاداش‌ها</h3>
          </div>
          <div class="section-content">
            <div class="claim-buttons-grid">
              <button id="profile-claim-btn" class="claim-btn primary">
                <div class="claim-btn-icon">🥇</div>
                <div class="claim-btn-content">
                  <div class="claim-btn-title">برداشت پاداش‌های باینری (1 پوینت)</div>
                  <div class="claim-btn-subtitle">پاداش‌های شبکه</div>
                </div>
              </button>
              <button id="profile-claim-monthly-btn" class="claim-btn secondary">
                <div class="claim-btn-icon">🗓️</div>
                <div class="claim-btn-content">
                  <div class="claim-btn-title">برداشت پاداش ماهانه</div>
                  <div class="claim-btn-subtitle">پاداش ماهانه</div>
                </div>
              </button>
            </div>
            <div id="profile-claim-status" class="claim-status"></div>
            <div id="profile-claim-monthly-status" class="claim-status"></div>
          </div>
        </div>
        
        <div id="profileStatus" class="profile-status"></div>
      </div>
    </div>
  </div>

  <div id="main-reports" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;display:none;">
    <div class="expand-header">
      <h2 class="profile-title"> </h2>
    </div>
    <div class="expand-content">
      <div class="profile-container">
        <div class="report-filters">
          <select id="report-type-filter">
            <option value="all">همه گزارشات</option>
            <option value="purchase">خریدها</option>
            <option value="activation">فعال‌سازی‌ها</option>
            <option value="binary">پاداش‌های باینری</option>
            <option value="trading">معاملات</option>
          </select>
          <button id="refresh-reports">به‌روزرسانی</button>
        </div>
        <div id="reports-container">
          <div class="loading-message">در حال بارگذاری گزارشات...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEWS section moved to news.html -->

  <!-- SHOP section moved to shop.html -->

  <div id="main-about" class="page-section expandable-container" style="display:none;">
    <div class="expand-header">
      <h2 class="profile-title"> </h2>
    </div>
    <div class="expand-content">
      <div class="about-container">
        <div class="about-content">
          <p>CONTINUOUS PROFIT ACADEMY یک پلتفرم نوآورانه برای آموزش، سرمایه‌گذاری و کسب درآمد از طریق توکن CPA و شبکه باینری است. هدف ما ایجاد بستری شفاف، سریع و کاربرپسند برای همه علاقه‌مندان به دنیای بلاکچین است.</p>
          
          <div class="about-features">
            <h3>ویژگی‌های کلیدی پلتفرم</h3>
            <ul>
              <li>خرید و فروش توکن CPA</li>
              <li>سیستم پاداش باینری</li>
              <li>فروشگاه محصولات آموزشی</li>
              <li>اخبار و آموزش‌های به‌روز</li>
              <li>امنیت بالا و شفافیت کامل</li>
              <li>پشتیبانی 24/7</li>
            </ul>
          </div>
          
          <div class="about-stats">
            <div class="about-stat">
              <div class="icon">👛</div>
              <div class="number" id="about-wallets-count">-</div>
              <div class="label">تعداد ولت‌های متصل</div>
            </div>
            <div class="about-stat">
              <div class="icon">🚀</div>
              <div class="number">1000+</div>
              <div class="label">کاربر فعال</div>
            </div>
            <div class="about-stat">
              <div class="icon">💰</div>
              <div class="number">$500K+</div>
              <div class="label">حجم معاملات</div>
            </div>
            <div class="about-stat">
              <div class="icon">⭐</div>
              <div class="number">4.9</div>
              <div class="label">امتیاز کاربران</div>
            </div>
            <div class="about-stat">
              <div class="icon">🔒</div>
              <div class="number">100%</div>
              <div class="label">امنیت تضمینی</div>
            </div>
          </div>
          
          <div class="about-contact">
            <h3>ارتباط با ما</h3>
            <p>برای سوالات و پشتیبانی با ما در تماس باشید</p>
            <div class="contact-info">
              <div class="contact-item">
                <span class="icon">📧</span>
                <span class="text">support@levelup.com</span>
              </div>
              <div class="contact-item">
                <span class="icon">📱</span>
                <span class="text">@LevelUp_Support</span>
              </div>
              <div class="contact-item">
                <span class="icon">🌐</span>
                <span class="text">www.levelup.com</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer style="direction:ltr;text-align:left;padding:0.2rem 1rem;font-size:0.7rem;color:rgba(170,170,170,0.7);position:fixed;left:0;bottom:0;width:100vw;background:rgba(35,41,70,0.75);backdrop-filter:blur(8px);z-index:100;text-align:center;border-top:1px solid rgba(167,134,255,0.3);box-shadow:0 -2px 10px rgba(0,0,0,0.15);">
    <div style="display:flex;justify-content:center;align-items:center;gap:0.5rem;max-width:300px;margin:0 auto;">
      <span style="font-size:0.65rem;">© LevelUp</span>
      <span style="color:rgba(167,134,255,0.6);font-size:0.6rem;">•</span>
      <span style="font-size:0.6rem;">Blockchain</span>
    </div>
  </footer>

  <!-- نمایش وضعیت اتصال -->
  <div id="connection-status" style="
    display: none;
    margin: 0 1rem 1rem 1rem;
    padding: 1rem;
    border-radius: 12px;
    font-family: 'Nazanin', 'B Nazanin', 'BNazanin', Tahoma, Arial, sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
  "></div>

  <!-- سایر اسکریپت‌ها -->
  <script src="js/config.js"></script>
  <script src="js/web3-interactions.js"></script>
  <script src="js/main.js"></script>
  <script src="js/swap.js?v=5.7"></script>
  <script src="js/network.js?v=5.7"></script>
  <script src="js/profile.js?v=5.7"></script>
  <script src="js/reports.js?v=5.7"></script>
  <script src="js/news.js?v=5.7"></script>
  <script src="js/shop.js?v=5.7"></script>
  <script src="js/homepage.js?v=5.8"></script>
  <script src="js/price-chart.js?v=5.7"></script>
  <script src="js/register.js?v=5.7"></script>
  <script>
    // ذخیره تب فعال در localStorage
    function setActiveTab(tab) {
      localStorage.setItem('activeTab', tab);
    }
    // بازیابی تب فعال از localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedTab = localStorage.getItem('activeTab');
      if (savedTab) {
        showTab(savedTab);
      }
      
      // بارگذاری خودکار درخت شبکه بعد از اتصال کیف پول
      setTimeout(async () => {
        try {
          if (window.contractConfig && window.contractConfig.address) {
            // اگر تب network فعال است، درخت را بارگذاری کن
            const networkSection = document.getElementById('main-network');
            if (networkSection && networkSection.style.display !== 'none') {
              if (typeof window.initializeNetworkTab === 'function') {
                await window.initializeNetworkTab();
              }
            }
          }
        } catch (error) {
          console.log('Network tree auto-load error:', error);
        }
      }, 4000); // 4 ثانیه صبر کن تا همه چیز لود شود
    });
    // افزودن ذخیره‌سازی به کلیک هر تب
    document.getElementById('tab-swap-btn').onclick = function() { setActiveTab('swap'); showTab('swap'); };
    document.getElementById('tab-network-btn').onclick = async function() { 
        setActiveTab('network'); 
        showTab('network'); 
        
        // بارگذاری خودکار درخت شبکه
        setTimeout(async () => {
            try {
                if (typeof window.initializeNetworkTab === 'function') {
                    await window.initializeNetworkTab();
                }
            } catch (error) {
                console.log('Network tab click load error:', error);
            }
        }, 500);
    };
    document.getElementById('tab-profile-btn').onclick = function() { setActiveTab('profile'); showTab('profile'); };
    document.getElementById('tab-reports-btn').onclick = function() { setActiveTab('reports'); showTab('reports'); };
    // NEWS and SHOP are now separate pages - no event listeners needed
    document.getElementById('tab-learning-btn').onclick = function() { setActiveTab('learning'); showTab('learning'); };
    document.getElementById('tab-about-btn').onclick = function() { setActiveTab('about'); showTab('about'); };
  </script>
  
  <!-- Disable expandable functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Remove all expand toggle buttons
        const expandButtons = document.querySelectorAll('.expand-toggle-btn');
        expandButtons.forEach(button => {
            button.style.display = 'none';
        });

        // Ensure all containers are expanded
        const expandableContainers = document.querySelectorAll('.expandable-container');
        expandableContainers.forEach(container => {
            container.classList.remove('collapsed');
            
            // Ensure content is always visible
            const content = container.querySelector('.expand-content');
            if (content) {
                content.style.maxHeight = 'none';
                content.style.opacity = '1';
                content.style.padding = '0.5rem';
                content.style.overflow = 'visible';
                content.style.display = 'block';
            }
            
            // Remove pointer cursor from headers
            const header = container.querySelector('.expand-header');
            if (header) {
                header.style.cursor = 'default';
            }
        });

        // Initialize price chart
        if (typeof window.priceChart !== 'undefined' && typeof window.priceChart.initialize === 'function') {
            window.priceChart.initialize();
        }
    });
  </script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script>
    (async () => {
      const { contract, address } = await window.connectWallet();
      const user = await contract.users(address);
      console.log('totalPurchasedKind:', user.totalPurchasedKind?.toString?.() ?? user.totalPurchasedKind);
    })();
  </script>
  <script>
    (async () => {
      const { contract, address } = await window.connectWallet();
      const events = await contract.queryFilter(contract.filters.PurchaseKind());
      console.log(events);
    })();
  </script>
  <script>
    async function updateAboutWalletsCount() {
      try {
        if (!window.contractConfig || !window.contractConfig.contract) {
          await window.connectWallet();
        }
        const contract = window.contractConfig.contract;
        if (contract && contract.wallets) {
          const walletsCount = await contract.wallets();
          document.getElementById('about-wallets-count').innerText = walletsCount.toString();
        } else {
          document.getElementById('about-wallets-count').innerText = '-';
        }
      } catch (e) {
        document.getElementById('about-wallets-count').innerText = '-';
      }
    }
    // Hook into tab switching
    const aboutBtn = document.getElementById('tab-about-btn');
    if (aboutBtn) {
      aboutBtn.addEventListener('click', updateAboutWalletsCount);
    }
  </script>
  <script>
    async function updateDashboardWalletsCount() {
      try {
        if (!window.contractConfig || !window.contractConfig.contract) {
          await window.connectWallet();
        }
        const contract = window.contractConfig.contract;
        if (contract && contract.wallets) {
          const walletsCount = await contract.wallets();
          document.getElementById('dashboard-wallets-count').innerText = walletsCount.toString();
        } else {
          document.getElementById('dashboard-wallets-count').innerText = '-';
        }
      } catch (e) {
        document.getElementById('dashboard-wallets-count').innerText = '-';
      }
    }
    // Update wallets count when dashboard (swap tab) is shown
    const swapBtn = document.getElementById('tab-swap-btn');
    if (swapBtn) {
      swapBtn.addEventListener('click', updateDashboardWalletsCount);
    }
    // Also update on initial load
    document.addEventListener('DOMContentLoaded', updateDashboardWalletsCount);
  </script>
  <script>
    function toggleDashboardChart(chartId, btn) {
      const chartDiv = document.getElementById(chartId);
      if (!chartDiv) return;
      const isOpen = chartDiv.style.display === 'block';
      chartDiv.style.display = isOpen ? 'none' : 'block';
      btn.textContent = isOpen ? '▼' : '▲';
      // Placeholder: Here you can load/render the chart if needed
    }
  </script>
  <!-- مودال افزودن/ویرایش ساب ادمین -->
  <div class="sub-admin-modal" id="sub-admin-modal">
    <div class="sub-admin-modal-content">
      <h3 id="modal-title">افزودن ساب ادمین جدید</h3>
      <form class="sub-admin-form" id="sub-admin-form">
        <div class="form-group">
          <label for="sub-admin-name">نام ساب ادمین:</label>
          <input type="text" id="sub-admin-name" placeholder="نام کامل ساب ادمین" required>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-address">آدرس کیف پول:</label>
          <input type="text" id="sub-admin-address" placeholder="0x..." required>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-role">نقش:</label>
          <select id="sub-admin-role" required>
            <option value="">انتخاب نقش</option>
            <option value="moderator">مدیر محتوا</option>
            <option value="support">پشتیبانی</option>
            <option value="analyst">تحلیلگر</option>
            <option value="teacher">مدرس</option>
            <option value="custom">سفارشی</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-description">توضیحات:</label>
          <textarea id="sub-admin-description" placeholder="توضیحات اضافی..." rows="3"></textarea>
        </div>
        
        <div class="permissions-group">
          <h5>🔐 دسترسی‌های ساب ادمین</h5>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-stream-control" name="permissions">
            <label for="perm-stream-control">کنترل لایو استریم</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-chat-moderate" name="permissions">
            <label for="perm-chat-moderate">مدیریت چت</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-ban-users" name="permissions">
            <label for="perm-ban-users">مسدود کردن کاربران</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-reports" name="permissions">
            <label for="perm-view-reports">مشاهده گزارش‌ها</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-manage-content" name="permissions">
            <label for="perm-manage-content">مدیریت محتوا</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-analytics" name="permissions">
            <label for="perm-view-analytics">مشاهده آمار</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-edit-products" name="permissions">
            <label for="perm-edit-products">ویرایش محصولات</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-orders" name="permissions">
            <label for="perm-view-orders">مشاهده سفارشات</label>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="submit" class="modal-btn primary" id="save-sub-admin-btn">💾 ذخیره</button>
          <button type="button" class="modal-btn secondary" id="cancel-sub-admin-btn">❌ انصراف</button>
        </div>
      </form>
    </div>
  </div>

  <!-- مودال تأیید حذف -->
  <div class="sub-admin-modal" id="delete-confirm-modal">
    <div class="sub-admin-modal-content">
      <h3>⚠️ تأیید حذف</h3>
      <p style="color: #ccc; text-align: center; margin-bottom: 1.5rem;">
        آیا مطمئن هستید که می‌خواهید این ساب ادمین را حذف کنید؟
      </p>
      <div style="background: #181c2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="color: #fff; margin: 0;"><strong>نام:</strong> <span id="delete-admin-name"></span></p>
        <p style="color: #888; margin: 0.5rem 0 0 0;"><strong>آدرس:</strong> <span id="delete-admin-address"></span></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn danger" id="confirm-delete-btn">🗑️ حذف</button>
        <button class="modal-btn secondary" id="cancel-delete-btn">❌ انصراف</button>
      </div>
    </div>
  </div>

  <div id="custom-footer-div" style="text-align:center; padding:2rem; color:#00ff88; font-size:1.2rem;">
  <br>  <br>  <br>  <br>  <br>  <br>  <br>
  </div>
  <script>
    window.showTab = async function(tab) {
      const tabs = ['swap','network','profile','reports','news','shop','learning','about'];
      tabs.forEach(function(name) {
        var mainEl = document.getElementById('main-' + name);
        if (mainEl) mainEl.style.display = (name === tab) ? '' : 'none';
        var btnEl = document.getElementById('tab-' + name + '-btn');
        if (btnEl) btnEl.classList.toggle('active', name === tab);
      });
      try {
        switch(tab) {
          case 'swap': break;
          case 'network':
            if (typeof window.initializeNetworkTab === 'function') {
              await window.initializeNetworkTab();
            } else {
              if (typeof updateNetworkStats === 'function') await updateNetworkStats();
              if (typeof renderNetworkTree === 'function') await renderNetworkTree();
            }
            break;
          case 'profile':
            if (typeof loadUserProfile === 'function') await loadUserProfile();
            break;
          case 'reports':
            if (typeof loadReports === 'function') await loadReports();
            break;
          case 'news':
            if (typeof loadNews === 'function') loadNews();
            if (typeof loadTutorials === 'function') loadTutorials();
            break;
          case 'shop':
            if (typeof loadProducts === 'function') loadProducts();
            break;
          case 'learning':
            if (typeof initializeLearningTab === 'function') initializeLearningTab();
            break;
          case 'about': break;
        }
      } catch (error) {
        console.error(`Error loading data for tab ${tab}:`, error);
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var archiveBtn = Array.from(document.querySelectorAll('button, a')).find(el => el.textContent.includes('آرشیو بازارهای مالی'));
      if (archiveBtn) archiveBtn.remove();
    });
  </script>

  <script>
  (async function() {
    if (window.getUserProfile) {
      const profile = await window.getUserProfile();
      if (!profile.activated) {
        // قفل کردن فقط بخش ریپورت
        const reportsSection = document.getElementById('main-reports');
        if (reportsSection) {
          reportsSection.innerHTML = '<div style="color:#ff6b6b;text-align:center;padding:3rem;font-size:1.5rem;">دسترسی به این بخش فقط برای کاربران فعال مجاز است.<br>🔒</div>';
          reportsSection.style.background = '#181c2a';
        }
      }
    }
  })();
  </script>

  <!-- کنترل نمایش ورودی آدرس مقصد -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const swapDirection = document.getElementById('swapDirection');
      const transferAddressRow = document.getElementById('transferAddressRow');
      
      if (swapDirection && transferAddressRow) {
        swapDirection.addEventListener('change', function() {
          if (swapDirection.value === 'transfer-matic' || swapDirection.value === 'transfer-lvl') {
            transferAddressRow.style.display = 'flex';
          } else {
            transferAddressRow.style.display = 'none';
          }
        });
      }
    });
  </script>

  <!-- کنترل عملکرد فرم انتقال POL و CPA -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const transferForm = document.getElementById('transferForm');
      const transferType = () => {
        const checkedRadio = document.querySelector('input[name="transferType"]:checked');
        if (checkedRadio) {
          return checkedRadio.value;
        } else {
          return 'matic';
        }
      };
      const transferAmount = document.getElementById('transferAmount');
      const transferTo = document.getElementById('transferTo');
      const transferStatus = document.getElementById('transferStatus');
      const transferButton = document.getElementById('transferButton');
      const searchIndexBtn = document.getElementById('searchIndexBtn');
      const searchIndexInput = document.getElementById('searchIndexInput');



      // عملکرد انتقال POL
      async function transferMatic(to, amount) {
        try {
          transferButton.disabled = true;
          transferStatus.textContent = 'در حال ارسال...';
          const walletConfig = await window.connectWallet();
          if (!walletConfig || !walletConfig.signer) throw new Error('اتصال کیف پول برقرار نشد');
          const value = ethers.parseEther(amount.toString());
          const tx = await walletConfig.signer.sendTransaction({ to, value });
          await tx.wait();
          transferStatus.textContent = 'انتقال POL با موفقیت انجام شد';
          transferStatus.className = 'swap-status success';
        } catch (e) {
          transferStatus.textContent = 'خطا در انتقال POL: ' + (e.message || e);
          transferStatus.className = 'swap-status error';
        } finally {
          transferButton.disabled = false;
        }
      }

      // عملکرد انتقال CPA
      async function transferLvl(to, amount) {
        try {
          transferButton.disabled = true;
          transferStatus.textContent = 'در حال ارسال...';
          const walletConfig = await window.connectWallet();
          if (!walletConfig || !walletConfig.contract) throw new Error('اتصال کیف پول برقرار نشد');
          const value = ethers.parseUnits(amount.toString(), 18);
          const tx = await walletConfig.contract.transfer(to, value);
          await tx.wait();
          transferStatus.textContent = 'انتقال CPA با موفقیت انجام شد';
          transferStatus.className = 'swap-status success';
        } catch (e) {
          transferStatus.textContent = 'خطا در انتقال CPA: ' + (e.message || e);
          transferStatus.className = 'swap-status error';
        } finally {
          transferButton.disabled = false;
        }
      }

      // هندلر فرم انتقال
      if (transferForm) {
        transferForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          transferStatus.textContent = '';
          transferStatus.className = 'swap-status';
          const type = transferType();
          const amount = transferAmount.value;
          const to = transferTo.value;
          
          if (!to || !ethers.isAddress(to)) {
            transferStatus.textContent = 'آدرس مقصد معتبر نیست';
            transferStatus.className = 'swap-status error';
            return;
          }
          if (!amount || parseFloat(amount) <= 0) {
            transferStatus.textContent = 'مقدار معتبر وارد کنید';
            transferStatus.className = 'swap-status error';
            return;
          }
          if (type === 'matic') {
            await transferMatic(to, amount);
          } else {
            await transferLvl(to, amount);
          }
        });
      }
    });
  </script>

  <!-- عملکرد باکس جستجوی ایندکس به آدرس -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const lookupIndexBtn = document.getElementById('lookupIndexBtn');
      const lookupIndexInput = document.getElementById('lookupIndexInput');
      const lookupAddressResult = document.getElementById('lookupAddressResult');
      if (lookupIndexBtn && lookupIndexInput && lookupAddressResult) {
        lookupIndexBtn.addEventListener('click', async function() {
          const idx = lookupIndexInput.value;
          lookupAddressResult.value = '';
          if (!idx || isNaN(idx) || parseInt(idx) < 1) {
            alert('ایندکس معتبر وارد کنید');
            return;
          }
          try {
            if (!window.contractConfig || !window.contractConfig.contract) {
              alert('اتصال به قرارداد برقرار نیست');
              return;
            }
            const contract = window.contractConfig.contract;
            const indexBig = BigInt(idx);
            const address = await contract.indexToAddress(indexBig);
            if (address && address !== '0x0000000000000000000000000000000000000000') {
              lookupAddressResult.value = address;
            } else {
              alert('آدرسی برای این ایندکس یافت نشد');
            }
          } catch (e) {
            alert('خطا در دریافت آدرس: ' + (e.message || e));
          }
        });
      }
    });
  </script>
</body>
</html>

<style>
.three-buttons-row {
  display: flex;
  gap: 1rem;
  margin: 2rem 0 1rem 0;
  width: 100%;
}
.three-btn {
  flex: 1;
  padding: 1.1rem 0.5rem;
  background: linear-gradient(135deg, #232946, #a786ff);
  color: #fff !important;
  border: none;
  border-radius: 15px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(167,134,255,0.08);
  position: relative;
  overflow: hidden;
  text-align: center;
}
.three-btn:hover {
  background: linear-gradient(135deg, #a786ff, #ff6b9d);
  color: #fff !important;
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(167, 134, 255, 0.2);
}
@media (max-width: 768px) {
  .three-buttons-row {
    flex-direction: column;
    gap: 0.7rem;
  }
  .three-btn {
    font-size: 1rem;
    padding: 1rem 0.5rem;
  }
}
#online-session-bubble {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 3000;
  background: linear-gradient(90deg, #00ff88 0%, #a786ff 100%);
  color: #181c2a;
  padding: 1rem 2.2rem 1rem 1.2rem;
  border-radius: 2.5rem;
  box-shadow: 0 6px 32px #00ff8840, 0 1.5px 0 #fff;
  display: flex;
  align-items: center;
  font-size: 1.15rem;
  font-weight: bold;
  animation: bubble-move 3.5s ease-in-out infinite alternate;
  border: 2px solid #fff;
  gap: 1.2rem;
  transition: all 0.3s;
}
.bubble-text {
  margin-left: 0.7rem;
  font-family: 'Noto Sans Arabic', 'Montserrat', sans-serif;
}
.bubble-timer {
  background: #fff2;
  color: #232946;
  border-radius: 1rem;
  padding: 0.2rem 0.8rem;
  font-size: 1rem;
  margin-left: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.04em;
}
.bubble-link {
  background: #232946;
  color: #fff !important;
  padding: 0.5rem 1.2rem;
  border-radius: 1.2rem;
  text-decoration: none;
  font-weight: 700;
  margin-left: 0.7rem;
  transition: background 0.2s;
  box-shadow: 0 2px 8px #a786ff40;
}
.bubble-link:hover {
  background: #a786ff;
  color: #232946 !important;
}
.bubble-close {
  cursor: pointer;
  font-size: 1.5rem;
  margin-right: 0.5rem;
  color: #232946;
  opacity: 0.7;
  transition: opacity 0.2s;
}
.bubble-close:hover {
  opacity: 1;
}
#bubble-mini {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 3001;
  width: 54px;
  height: 54px;
  background: linear-gradient(135deg, #00ff88 0%, #a786ff 100%);
  border-radius: 50%;
  box-shadow: 0 4px 16px #00ff8840, 0 1.5px 0 #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid #fff;
  font-size: 2rem;
  opacity: 0.95;
}
#bubble-mini:hover {
  opacity: 1;
  box-shadow: 0 8px 32px #a786ff40;
}
.bubble-mini-icon {
  font-size: 2rem;
  color: #232946;
}
@keyframes bubble-move {
  0% { transform: translateY(0) scale(1); box-shadow: 0 6px 32px #00ff8840; }
  50% { transform: translateY(-12px) scale(1.04); box-shadow: 0 16px 48px #a786ff40; }
  100% { transform: translateY(0) scale(1); box-shadow: 0 6px 32px #00ff8840; }
}
@media (max-width: 600px) {
  #online-session-bubble {
    right: 8px;
    left: 8px;
    top: 8px;
    padding: 0.7rem 1rem 0.7rem 0.7rem;
    font-size: 1rem;
    flex-direction: column;
    align-items: flex-start;
    border-radius: 1.2rem;
    gap: 0.5rem;
  }
  .bubble-link {
    margin-left: 0;
    margin-top: 0.3rem;
  }
  #bubble-mini {
    right: 8px;
    top: 8px;
    width: 44px;
    height: 44px;
    font-size: 1.3rem;
  }
}
</style>
